import { useState, useEffect } from 'react';
import { Plus, Trash2, Calculator, Loader2, Mail } from 'lucide-react';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { Slider } from '@/components/ui/slider';
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from '@/components/ui/accordion';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import AddressAutocomplete from '@/components/AddressAutocomplete';
import { calculerDevisSupabase } from '@/services/tarificateur';
import type { DevisOutput, Gamme, Option, Commission } from '@/services/tarificateur';
import { enregistrerDemandeDevis } from '@/services/tarificateur/supabase';
import {
  buildDevisInput,
  buildBeneficiairesData,
  buildDemandeDevisData,
  isDateComplete,
  isFormReadyForSave,
} from '@/services/devis';
import '@/services/tarificateur/testSupabase';

// Fonction pour formater les prix √† la fran√ßaise
function formatPrixFR(prix: number): string {
  return new Intl.NumberFormat('fr-FR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(prix);
}

// Garanties par option
const GARANTIES_PAR_OPTION: Record<number, { titre: string; garanties: string[] }> = {
  1: {
    titre: 'Option 1 - √âconomique',
    garanties: [
      'Hospitalisation : Base s√©curit√© sociale',
      'Consultations : Remboursement partiel',
      'M√©dicaments : Taux s√©curit√© sociale',
      'Optique : Forfait limit√©',
    ],
  },
  2: {
    titre: 'Option 2 - Interm√©diaire',
    garanties: [
      'Hospitalisation : 100% BR + forfait',
      'Consultations : 100% + d√©passements',
      'M√©dicaments : 100% tous niveaux',
      'Optique : Forfait renforc√©',
    ],
  },
  3: {
    titre: 'Option 3 - Confort',
    garanties: [
      'Hospitalisation : 150% BR + chambre particuli√®re',
      'Consultations : 200% dont d√©passements',
      'M√©dicaments : 100% + hom√©opathie',
      'Optique : Forfait √©lev√© + verres complexes',
      'Dentaire : Proth√®ses + orthodontie adulte',
    ],
  },
  4: {
    titre: 'Option 4 - Confort Plus',
    garanties: [
      'Hospitalisation : 200% BR + chambre particuli√®re',
      'Consultations : 250% dont d√©passements',
      'M√©dicaments : 100% + hom√©opathie + phytoth√©rapie',
      'Optique : Forfait premium + montures de marque',
      'Dentaire : Proth√®ses + implants + orthodontie',
      'M√©decines douces : Ost√©opathie, acupuncture',
    ],
  },
  5: {
    titre: 'Option 5 - Excellence',
    garanties: [
      'Hospitalisation : 300% BR + cliniques priv√©es',
      'Consultations : 300% tous m√©decins',
      'M√©dicaments : 100% + m√©decines alternatives',
      'Optique : Forfait excellence + toutes montures',
      'Dentaire : Implants + proth√®ses haut de gamme',
      'M√©decines douces : Forfait illimit√©',
      'Cures thermales : Prise en charge',
    ],
  },
  6: {
    titre: 'Option 6 - Premium',
    garanties: [
      'Hospitalisation : 400% BR + √©tablissements priv√©s',
      'Consultations : 400% sans limite',
      'M√©dicaments : Prise en charge totale',
      'Optique : Forfait maximum + toutes technologies',
      'Dentaire : Implants + esth√©tique dentaire',
      'M√©decines douces : Sans limite',
      'Cures thermales : Prise en charge compl√®te',
      'Assistance : Rapatriement, second avis m√©dical',
    ],
  },
};

interface Enfant {
  prenom: string;
  nom: string;
  dateNaissance: string;
}

interface FormData {
  gamme: Gamme;
  adresseComplete: string;
  codePostal: string;
  dateEffet: string;
  assurePrenom: string;
  assureNom: string;
  assureEmail: string;
  assureNaissance: string;
  assureSeul: boolean;
  conjointPrenom: string;
  conjointNom: string;
  conjointNaissance: string;
  enfants: Enfant[];
  option: Option;
  surcomplementaire: boolean;
  renfortHospi: boolean;
  commission: Commission;
  rgpdConsent: boolean;
}

export default function DevisForm() {
  const [showForm, setShowForm] = useState(false);
  const [tempRgpdConsent, setTempRgpdConsent] = useState(false);

  const [formData, setFormData] = useState<FormData>({
    gamme: '' as Gamme, // Vide par d√©faut
    adresseComplete: '',
    codePostal: '',
    dateEffet: new Date().toISOString().split('T')[0],
    assurePrenom: '',
    assureNom: '',
    assureEmail: '',
    assureNaissance: '',
    assureSeul: true, // Coch√© par d√©faut
    conjointPrenom: '',
    conjointNom: '',
    conjointNaissance: '',
    enfants: [],
    option: 3,
    surcomplementaire: false,
    renfortHospi: false,
    commission: 10,
    rgpdConsent: false,
  });

  const [devis, setDevis] = useState<DevisOutput | null>(null);
  const [_error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [hasConjoint, setHasConjoint] = useState(false);

  const handleStartDevis = () => {
    if (tempRgpdConsent) {
      setFormData(prev => ({ ...prev, rgpdConsent: true }));
      setShowForm(true);
      // Scroll vers le haut de la page
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  // G√©rer "Assur√© seul" automatiquement
  useEffect(() => {
    // D√©cocher si conjoint ou enfant ajout√©
    if ((hasConjoint || formData.enfants.length > 0) && formData.assureSeul) {
      setFormData(prev => ({ ...prev, assureSeul: false }));
    }
    // Recocher si plus de conjoint ni d'enfants (pour TNS uniquement)
    else if (!hasConjoint && formData.enfants.length === 0 && !formData.assureSeul && formData.gamme === 'TNS_FORMULES') {
      setFormData(prev => ({ ...prev, assureSeul: true }));
    }
  }, [hasConjoint, formData.enfants.length, formData.gamme]);

  // Calcul automatique en temps r√©el (seulement sur les champs qui impactent le tarif)
  useEffect(() => {
    if (
      formData.gamme &&
      formData.codePostal.length === 5 &&
      formData.dateEffet &&
      isDateComplete(formData.assureNaissance) && // Au moins la date de l'assur√©
      formData.rgpdConsent // Consentement RGPD obligatoire
    ) {
      // Recalculer m√™me si les dates des b√©n√©ficiaires ne sont pas compl√®tes
      // Cela permet de passer de "Assur√© seul" √† "Assur√©" d√®s qu'on ajoute un conjoint/enfant
      calculerDevisAutomatique();
    }
  }, [
    formData.gamme,
    formData.codePostal,
    formData.dateEffet,
    formData.assureNaissance,
    formData.assureSeul,
    formData.conjointNaissance, // Seulement la date, pas le nom/pr√©nom
    formData.enfants.map(e => e.dateNaissance).join(','), // Seulement les dates
    formData.option,
    formData.surcomplementaire,
    formData.renfortHospi,
    formData.commission,
    formData.rgpdConsent,
    hasConjoint, // Important : recalcule d√®s qu'on ajoute/enl√®ve un conjoint
  ]);

  const calculerDevisAutomatique = async () => {
    try {
      setError(null);
      setIsLoading(true);

      // Construire l'input pour le calculateur
      const input = buildDevisInput(formData, hasConjoint);

      // Calculer le devis
      const result = await calculerDevisSupabase(input);
      setDevis(result);

      // Enregistrer la demande de devis si toutes les infos sont compl√®tes
      if (isFormReadyForSave(formData, result.tarifMensuel)) {
        const beneficiaires = buildBeneficiairesData(formData, result, hasConjoint);
        const demandeData = buildDemandeDevisData(formData, result, beneficiaires);

        // Enregistrer dans Supabase (en arri√®re-plan, sans bloquer l'affichage)
        enregistrerDemandeDevis(demandeData).catch(error => {
          console.error('Erreur lors de l\'enregistrement du devis:', error);
          // Ne pas afficher l'erreur √† l'utilisateur, juste logger
        });
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Erreur lors du calcul');
      setDevis(null);
    } finally {
      setIsLoading(false);
    }
  };

  const ajouterEnfant = () => {
    setFormData(prev => ({
      ...prev,
      enfants: [...prev.enfants, { prenom: '', nom: '', dateNaissance: '' }],
    }));
  };

  const supprimerEnfant = (index: number) => {
    setFormData(prev => ({
      ...prev,
      enfants: prev.enfants.filter((_, i) => i !== index),
    }));
  };

  const updateEnfant = (index: number, field: keyof Enfant, value: string) => {
    setFormData(prev => ({
      ...prev,
      enfants: prev.enfants.map((e, i) => (i === index ? { ...e, [field]: value } : e)),
    }));
  };

  const handleAddressChange = (address: string, postalCode: string) => {
    setFormData(prev => ({
      ...prev,
      adresseComplete: address,
      codePostal: postalCode,
    }));
  };

  // Page d'introduction avec consentement RGPD
  if (!showForm) {
    return (
      <div className="max-w-3xl mx-auto">
        <Card className="shadow-lg border-0">
          <CardHeader className="bg-gradient-to-r from-[#407b85]/10 to-transparent border-b pb-8">
            <div className="text-center">
              <div className="w-20 h-20 bg-gradient-to-br from-[#407b85] to-[#407b85]/80 rounded-full flex items-center justify-center mx-auto mb-4">
                <Calculator className="w-10 h-10 text-white" />
              </div>
              <CardTitle className="text-2xl mb-2">Tarificateur Sant√© WALTERA</CardTitle>
              <CardDescription className="text-base">
                Obtenez un devis personnalis√© de compl√©mentaire sant√© en quelques clics
              </CardDescription>
            </div>
          </CardHeader>
          <CardContent className="pt-8 space-y-6">
            {/* Avantages */}
            <div className="space-y-4">
              <h3 className="font-semibold text-gray-900">Ce que vous allez obtenir :</h3>
              <div className="space-y-3">
                {[
                  'Tarif personnalis√© en temps r√©el',
                  'D√©tails par b√©n√©ficiaire (assur√©, conjoint, enfants)',
                  'Comparaison des options de couverture',
                  'Liste des garanties incluses',
                  'Calcul imm√©diat et gratuit',
                ].map((item, index) => (
                  <div key={index} className="flex items-center space-x-3">
                    <div className="w-6 h-6 rounded-full bg-[#407b85]/10 flex items-center justify-center flex-shrink-0">
                      <span className="text-[#407b85] font-bold text-sm">‚úì</span>
                    </div>
                    <span className="text-gray-700">{item}</span>
                  </div>
                ))}
              </div>
            </div>

            {/* Consentement RGPD */}
            <div className="border-t pt-6">
              <div className="bg-blue-50 p-6 rounded-xl border-2 border-blue-200">
                <div className="flex items-start space-x-4">
                  <Checkbox
                    id="rgpdConsentIntro"
                    checked={tempRgpdConsent}
                    onCheckedChange={(checked) => setTempRgpdConsent(checked as boolean)}
                    className="mt-1"
                  />
                  <Label htmlFor="rgpdConsentIntro" className="cursor-pointer text-sm text-gray-700 leading-relaxed">
                    <span className="font-bold text-gray-900 text-base block mb-2">
                      Protection de vos donn√©es personnelles
                    </span>
                    <p className="mb-3">
                      J'accepte que mes donn√©es personnelles (nom, pr√©nom, email, adresse et informations de sant√©) soient collect√©es et trait√©es par <strong>WALTERA</strong> dans le cadre de l'√©tablissement de mon devis de compl√©mentaire sant√©.
                    </p>
                    <p className="text-xs text-gray-600">
                      Ces donn√©es sont n√©cessaires pour calculer votre tarif et vous contacter. Conform√©ment au RGPD, vous disposez d'un droit d'acc√®s, de rectification et de suppression de vos donn√©es en contactant{' '}
                      <a href="mailto:contact@waltera.fr" className="text-[#407b85] hover:underline font-semibold">
                        contact@waltera.fr
                      </a>
                      .
                    </p>
                  </Label>
                </div>
              </div>
            </div>

            {/* Bouton */}
            <div className="flex justify-center pt-4">
              <Button
                onClick={handleStartDevis}
                disabled={!tempRgpdConsent}
                className="bg-gradient-to-r from-[#407b85] to-[#407b85]/80 hover:from-[#407b85]/90 hover:to-[#407b85]/70 text-white font-semibold px-8 py-6 text-lg h-auto"
              >
                <Calculator className="w-5 h-5 mr-3" />
                Obtenir mon devis
              </Button>
            </div>

            {/* Note s√©curit√© */}
            <div className="text-center text-xs text-gray-500 pt-4 border-t">
              <p>üîí Vos donn√©es sont s√©curis√©es et ne seront jamais partag√©es avec des tiers</p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Formulaire principal (affich√© apr√®s consentement)
  return (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
      {/* Formulaire - 2 colonnes */}
      <div className={`lg:col-span-2 ${(devis || isLoading) ? 'pb-32 lg:pb-0' : ''}`}>
        <Card className="shadow-md border-0">
          <CardHeader className="bg-gradient-to-r from-[#407b85]/5 to-transparent border-b">
            <CardTitle className="text-xl text-gray-900">Informations du Devis</CardTitle>
          </CardHeader>
          <CardContent className="space-y-6 pt-6">
            {/* Informations g√©n√©rales */}
            <div className="space-y-4">
              {/* Gamme */}
              <div className="space-y-2">
                <Label htmlFor="gamme" className="text-gray-700 font-medium">
                  Gamme <span className="text-red-500">*</span>
                </Label>
                <Select
                  value={formData.gamme || undefined}
                  onValueChange={(value: Gamme) =>
                    setFormData(prev => ({ ...prev, gamme: value }))
                  }
                >
                  <SelectTrigger id="gamme" className="border-gray-300">
                    <SelectValue placeholder="S√©lectionnez une gamme..." />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="SANTE_SENIORS">Sant√© Seniors</SelectItem>
                    <SelectItem value="SANTE_SENIORS_PLUS">Sant√© Seniors Plus</SelectItem>
                    <SelectItem value="TNS_FORMULES">TNS Formules</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {/* Adresse avec autocomplete */}
              <AddressAutocomplete
                value={formData.adresseComplete}
                onChange={handleAddressChange}
                label="Adresse du client"
                placeholder="Commencez √† taper l'adresse..."
                required
              />

              {/* Code postal (en lecture seule, rempli par l'autocomplete) */}
              {formData.codePostal && formData.codePostal.length === 5 && (
                <div className="bg-[#407b85]/10 rounded-lg p-3 border border-[#407b85]/30">
                  <p className="text-xs text-[#407b85] mb-1 font-medium">Code postal d√©tect√©</p>
                  <p className="text-sm font-semibold text-[#407b85]">{formData.codePostal}</p>
                </div>
              )}

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {/* Date d'effet */}
                <div className="space-y-2">
                  <Label htmlFor="dateEffet" className="text-gray-700 font-medium">Date d'Effet</Label>
                  <Input
                    id="dateEffet"
                    type="date"
                    value={formData.dateEffet}
                    onChange={(e) =>
                      setFormData(prev => ({ ...prev, dateEffet: e.target.value }))
                    }
                    className="border-gray-300"
                  />
                </div>

                {/* Commission */}
                <div className="space-y-2">
                  <Label htmlFor="commission" className="text-gray-700 font-medium">Commission</Label>
                  <Select
                    value={formData.commission.toString()}
                    onValueChange={(value) =>
                      setFormData(prev => ({ ...prev, commission: parseInt(value) as Commission }))
                    }
                  >
                    <SelectTrigger id="commission" className="border-gray-300">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="10">10%</SelectItem>
                      <SelectItem value="15">15%</SelectItem>
                      <SelectItem value="20">20%</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>
            </div>

            {/* Composition du foyer */}
            <div className="space-y-4 border-t pt-6">
              <h3 className="font-semibold text-lg text-gray-900">Assur√© principal</h3>

              {/* Pr√©nom et Nom de l'assur√© */}
              <div className="grid grid-cols-2 gap-3">
                <div className="space-y-2">
                  <Label htmlFor="assurePrenom" className="text-gray-700 font-medium">
                    Pr√©nom <span className="text-red-500">*</span>
                  </Label>
                  <Input
                    id="assurePrenom"
                    placeholder="Jean"
                    value={formData.assurePrenom}
                    onChange={(e) =>
                      setFormData(prev => ({ ...prev, assurePrenom: e.target.value }))
                    }
                    className="border-gray-300"
                    required
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="assureNom" className="text-gray-700 font-medium">
                    Nom <span className="text-red-500">*</span>
                  </Label>
                  <Input
                    id="assureNom"
                    placeholder="Dupont"
                    value={formData.assureNom}
                    onChange={(e) =>
                      setFormData(prev => ({ ...prev, assureNom: e.target.value }))
                    }
                    className="border-gray-300"
                    required
                  />
                </div>
              </div>

              {/* Email de l'assur√© */}
              <div className="space-y-2">
                <Label htmlFor="assureEmail" className="text-gray-700 font-medium">
                  Email <span className="text-red-500">*</span>
                </Label>
                <div className="relative">
                  <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" />
                  <Input
                    id="assureEmail"
                    type="email"
                    placeholder="jean.dupont@exemple.fr"
                    value={formData.assureEmail}
                    onChange={(e) =>
                      setFormData(prev => ({ ...prev, assureEmail: e.target.value }))
                    }
                    className="pl-10 border-gray-300"
                    required
                  />
                </div>
              </div>

              {/* Date de naissance */}
              <div className="space-y-2">
                <Label htmlFor="assureNaissance" className="text-gray-700 font-medium">
                  Date de naissance <span className="text-red-500">*</span>
                </Label>
                <Input
                  id="assureNaissance"
                  type="date"
                  value={formData.assureNaissance}
                  onChange={(e) =>
                    setFormData(prev => ({ ...prev, assureNaissance: e.target.value }))
                  }
                  className="border-gray-300"
                  required
                />
              </div>

              {/* TNS Assur√© seul */}
              {formData.gamme === 'TNS_FORMULES' && (
                <div className="flex items-center space-x-2 bg-blue-50 p-3 rounded-lg">
                  <Checkbox
                    id="assureSeul"
                    checked={formData.assureSeul}
                    onCheckedChange={(checked) =>
                      setFormData(prev => ({ ...prev, assureSeul: checked as boolean }))
                    }
                    disabled={hasConjoint || formData.enfants.length > 0}
                  />
                  <Label htmlFor="assureSeul" className="cursor-pointer text-sm">
                    Assur√© seul (sans conjoint ni enfants)
                  </Label>
                </div>
              )}

              {/* Conjoint */}
              <div className="space-y-3">
                <div className="flex items-center space-x-2">
                  <Checkbox
                    id="hasConjoint"
                    checked={hasConjoint}
                    onCheckedChange={(checked) => {
                      setHasConjoint(checked as boolean);
                      if (!checked) {
                        setFormData(prev => ({
                          ...prev,
                          conjointPrenom: '',
                          conjointNom: '',
                          conjointNaissance: ''
                        }));
                      }
                    }}
                  />
                  <Label htmlFor="hasConjoint" className="cursor-pointer font-medium">
                    Ajouter un conjoint
                  </Label>
                </div>
                {hasConjoint && (
                  <div className="space-y-3 pl-6 border-l-2 border-[#407b85]/20">
                    <div className="grid grid-cols-2 gap-3">
                      <Input
                        type="text"
                        placeholder="Pr√©nom"
                        value={formData.conjointPrenom}
                        onChange={(e) =>
                          setFormData(prev => ({ ...prev, conjointPrenom: e.target.value }))
                        }
                        className="border-gray-300"
                      />
                      <Input
                        type="text"
                        placeholder="Nom"
                        value={formData.conjointNom}
                        onChange={(e) =>
                          setFormData(prev => ({ ...prev, conjointNom: e.target.value }))
                        }
                        className="border-gray-300"
                      />
                    </div>
                    <Input
                      type="date"
                      placeholder="Date de naissance"
                      value={formData.conjointNaissance}
                      onChange={(e) =>
                        setFormData(prev => ({ ...prev, conjointNaissance: e.target.value }))
                      }
                      className="border-gray-300"
                    />
                  </div>
                )}
              </div>

              {/* Enfants */}
              <div className="space-y-3">
                <div className="flex items-center justify-between">
                  <Label className="font-medium">Enfants</Label>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={ajouterEnfant}
                    className="border-[#407b85] text-[#407b85] hover:bg-[#407b85] hover:text-white"
                  >
                    <Plus className="h-4 w-4 mr-1" />
                    Ajouter un enfant
                  </Button>
                </div>
                {formData.enfants.map((enfant, index) => (
                  <div key={index} className="space-y-3 pl-6 border-l-2 border-[#407b85]/20 pb-3">
                    <div className="flex items-start justify-between">
                      <Label className="text-sm font-medium text-gray-700">Enfant {index + 1}</Label>
                      <Button
                        type="button"
                        variant="ghost"
                        size="sm"
                        onClick={() => supprimerEnfant(index)}
                        className="text-red-600 hover:text-red-700 hover:bg-red-50 h-7"
                      >
                        <Trash2 className="h-3 w-3 mr-1" />
                        Supprimer
                      </Button>
                    </div>
                    <div className="grid grid-cols-2 gap-2">
                      <Input
                        type="text"
                        placeholder="Pr√©nom"
                        value={enfant.prenom}
                        onChange={(e) => updateEnfant(index, 'prenom', e.target.value)}
                        className="border-gray-300"
                      />
                      <Input
                        type="text"
                        placeholder="Nom"
                        value={enfant.nom}
                        onChange={(e) => updateEnfant(index, 'nom', e.target.value)}
                        className="border-gray-300"
                      />
                    </div>
                    <Input
                      type="date"
                      placeholder="Date de naissance"
                      value={enfant.dateNaissance}
                      onChange={(e) => updateEnfant(index, 'dateNaissance', e.target.value)}
                      className="border-gray-300"
                    />
                  </div>
                ))}
              </div>
            </div>

            {/* Options */}
            <div className="space-y-4 border-t pt-6">
              <h3 className="font-semibold text-lg text-gray-900">Options de couverture</h3>

              {/* Option avec Slider */}
              <div className="space-y-3">
                <div className="flex items-center justify-between mb-2">
                  <Label className="text-gray-700 font-medium">
                    Niveau de couverture
                  </Label>
                  <span className="text-sm font-semibold text-[#407b85] bg-[#407b85]/10 px-3 py-1.5 rounded-lg">
                    Option {formData.option}
                  </span>
                </div>

                <div className="space-y-1 px-1">
                  <Slider
                    min={1}
                    max={6}
                    step={1}
                    value={[formData.option]}
                    onValueChange={([value]) => {
                      setFormData(prev => ({
                        ...prev,
                        option: value as Option,
                        // D√©cocher surcompl√©mentaire si option < 3
                        surcomplementaire: value < 3 ? false : prev.surcomplementaire
                      }))
                    }}
                    className="w-full"
                  />
                  <div className="flex justify-between items-center text-xs">
                    <span className="text-gray-600 font-medium">√âconomique</span>
                    <span className="text-gray-600 font-medium">Premium</span>
                  </div>
                </div>
              </div>

              {/* Surcompl√©mentaire */}
              <div className="flex items-center space-x-2 bg-gray-50 p-3 rounded-lg">
                <Checkbox
                  id="surcomplementaire"
                  checked={formData.surcomplementaire}
                  onCheckedChange={(checked) =>
                    setFormData(prev => ({ ...prev, surcomplementaire: checked as boolean }))
                  }
                  disabled={formData.option < 3}
                />
                <Label
                  htmlFor="surcomplementaire"
                  className={formData.option < 3 ? 'opacity-50 text-sm' : 'cursor-pointer text-sm'}
                >
                  Surcompl√©mentaire {formData.option < 3 && '(disponible √† partir de l\'option 3)'}
                </Label>
              </div>

              {/* Renfort Hospi */}
              {formData.gamme === 'SANTE_SENIORS_PLUS' && (
                <div className="flex items-center space-x-2 bg-gray-50 p-3 rounded-lg">
                  <Checkbox
                    id="renfortHospi"
                    checked={formData.renfortHospi}
                    onCheckedChange={(checked) =>
                      setFormData(prev => ({ ...prev, renfortHospi: checked as boolean }))
                    }
                  />
                  <Label htmlFor="renfortHospi" className="cursor-pointer text-sm">
                    Renfort Hospitalisation
                  </Label>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* R√©sultats - Sticky droite sur desktop, sticky bas sur mobile */}
      {((devis !== null && devis.tarifMensuel > 0) || isLoading) && (
        <div className="lg:col-span-1">
          {/* Desktop : sticky √† droite */}
          <div className="hidden lg:block lg:sticky lg:top-24">
            <Card className="shadow-lg border-0 overflow-hidden">
              {/* Header avec gradient teal */}
              <div className="bg-gradient-to-r from-[#407b85] to-[#407b85]/80 p-5 text-white">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-2">
                    <Calculator className="h-5 w-5" />
                    <h3 className="text-lg font-bold">R√©sultat du Devis</h3>
                  </div>
                  {devis && !isLoading && (
                    <span className="text-xs bg-white/20 px-2.5 py-0.5 rounded-full font-medium">
                      ‚úì
                    </span>
                  )}
                </div>
              </div>

              <CardContent className="pt-6">
                {/* Loading */}
                {isLoading && (
                  <div className="text-center py-12">
                    <Loader2 className="h-12 w-12 mx-auto mb-4 animate-spin text-[#407b85]" />
                    <p className="font-medium text-gray-900">Calcul en cours...</p>
                    <p className="text-xs text-gray-500 mt-2">Interrogation de la base de donn√©es Supabase</p>
                  </div>
                )}

                {/* R√©sultat */}
                {devis && !isLoading && (
                  <div className="space-y-5">
                    {/* Tarif principal */}
                    <div className="bg-gradient-to-br from-[#407b85]/10 to-[#407b85]/5 rounded-xl p-5 text-center border-2 border-[#407b85]/30">
                      <p className="text-xs font-medium text-[#407b85] mb-2">Tarif Mensuel Total</p>
                      <p className="text-4xl font-bold text-[#407b85] mb-1">
                        {formatPrixFR(devis.tarifMensuel)} ‚Ç¨
                      </p>
                      <p className="text-xs text-[#407b85]/80">par mois TTC</p>
                    </div>

                    {/* D√©tails par b√©n√©ficiaire */}
                    <div className="space-y-3">
                      <h4 className="font-semibold text-gray-900">
                        D√©tails par b√©n√©ficiaire
                      </h4>
                      {devis.details.map((detail, index) => (
                        <div key={index} className="bg-white border border-gray-200 rounded-lg p-4 space-y-3 hover:border-[#407b85]/50 transition-colors">
                          <div className="flex justify-between items-center border-b border-gray-100 pb-2">
                            <span className="font-semibold text-gray-900">{detail.beneficiaire}</span>
                            <span className="text-sm bg-[#407b85]/10 text-[#407b85] px-2 py-1 rounded-full font-medium">
                              {detail.age} ans
                            </span>
                          </div>
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between">
                              <span className="text-gray-600">Tarif de base</span>
                              <span className="font-medium text-gray-900">{formatPrixFR(detail.tarifBase)} ‚Ç¨</span>
                            </div>
                            {detail.tarifSurco > 0 && (
                              <div className="flex justify-between">
                                <span className="text-gray-600">Surcompl√©mentaire</span>
                                <span className="font-medium text-gray-900">{formatPrixFR(detail.tarifSurco)} ‚Ç¨</span>
                              </div>
                            )}
                            {detail.tarifRenfort > 0 && (
                              <div className="flex justify-between">
                                <span className="text-gray-600">Renfort hospi</span>
                                <span className="font-medium text-gray-900">{formatPrixFR(detail.tarifRenfort)} ‚Ç¨</span>
                              </div>
                            )}
                            <div className="flex justify-between font-bold pt-2 border-t border-gray-200 text-[#407b85]">
                              <span>Total</span>
                              <span>{formatPrixFR(detail.total)} ‚Ç¨</span>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>

                    {/* Garanties principales (Accordion) */}
                    <Accordion type="single" collapsible className="border-t">
                      <AccordionItem value="garanties" className="border-0">
                        <AccordionTrigger className="text-sm font-semibold text-gray-900 hover:text-[#407b85] py-3">
                          Garanties principales ({GARANTIES_PAR_OPTION[formData.option].garanties.length})
                        </AccordionTrigger>
                        <AccordionContent className="pb-4">
                          <div className="space-y-2">
                            {GARANTIES_PAR_OPTION[formData.option].garanties.map((garantie, index) => (
                              <div key={index} className="flex items-start space-x-2">
                                <span className="text-[#407b85] mt-0.5 flex-shrink-0">‚úì</span>
                                <span className="text-xs text-gray-600">{garantie}</span>
                              </div>
                            ))}
                          </div>
                        </AccordionContent>
                      </AccordionItem>
                    </Accordion>

                    {/* Note */}
                    <div className="text-xs text-gray-500 bg-gray-50 rounded-lg p-3 space-y-1">
                      <p>‚Ä¢ Tarifs TTC incluant les droits ACPS (1,50 ‚Ç¨/mois)</p>
                      <p>‚Ä¢ Droit d'entr√©e unique de 10,00 ‚Ç¨ non inclus</p>
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>

          {/* Mobile : sticky en bas de l'√©cran - Version condens√©e */}
          <div className="lg:hidden fixed bottom-0 left-0 right-0 z-50">
            <Card className="shadow-2xl border-0 rounded-t-xl rounded-b-none overflow-hidden">
              {/* Header avec gradient teal - Version compacte */}
              <div className="bg-gradient-to-r from-[#407b85] to-[#407b85]/80 px-4 py-2.5 text-white">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-2">
                    <Calculator className="h-4 w-4" />
                    <h3 className="text-sm font-bold">R√©sultat</h3>
                  </div>
                  {devis && !isLoading && (
                    <span className="text-xs bg-white/20 px-2 py-0.5 rounded-full font-medium">
                      ‚úì
                    </span>
                  )}
                </div>
              </div>

              <CardContent className="pt-3 pb-3 px-4">
                {/* Loading */}
                {isLoading && (
                  <div className="text-center py-4">
                    <Loader2 className="h-8 w-8 mx-auto mb-2 animate-spin text-[#407b85]" />
                    <p className="font-medium text-gray-900 text-xs">Calcul...</p>
                  </div>
                )}

                {/* R√©sultat */}
                {devis && !isLoading && (
                  <div className="space-y-2">
                    {/* Tarif principal - Version ultra compacte */}
                    <div className="bg-gradient-to-br from-[#407b85]/10 to-[#407b85]/5 rounded-lg p-2.5 text-center border border-[#407b85]/30">
                      <p className="text-2xl font-bold text-[#407b85] leading-none">
                        {formatPrixFR(devis.tarifMensuel)} ‚Ç¨<span className="text-xs font-normal text-[#407b85]/70">/mois</span>
                      </p>
                    </div>

                    {/* Infos condens√©es sur une ligne */}
                    <div className="flex items-center justify-between text-xs">
                      <span className="text-gray-600 truncate flex-1 mr-2">{devis.produit}</span>
                      <div className="flex items-center space-x-2 flex-shrink-0">
                        <span className="bg-gray-100 text-gray-700 px-2 py-0.5 rounded font-medium">
                          {devis.zone}
                        </span>
                        <span className="text-gray-600">
                          {devis.details.length} pers.
                        </span>
                      </div>
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        </div>
      )}
    </div>
  );
}
